angular.module("mean",["ngCookies","ngResource","ui.bootstrap","ui.route","mean.system","mean.directives"]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"views/index.html"}).when("/app",{templateUrl:"/views/app.html"}).when("/privacy",{templateUrl:"/views/privacy.html"}).when("/bottom",{templateUrl:"/views/bottom.html"}).when("/signin",{templateUrl:"/views/signin.html"}).when("/signup",{templateUrl:"/views/signup.html"}).when("/choose-avatar",{templateUrl:"/views/choose-avatar.html"}).otherwise({redirectTo:"/"})}]).config(["$locationProvider",function(e){e.hashPrefix("!")}]).run(["$rootScope",function(e){e.safeApply=function(e){var n=this.$root.$$phase;"$apply"==n||"$digest"==n?e&&"function"==typeof e&&e():this.$apply(e)}}]).run(["DonationService",function(e){window.userDonationCb=function(n){e.userDonated(n)}}]),angular.module("mean.system",[]),angular.module("mean.directives",[]),angular.module("mean.directives",[]).directive("player",function(){return{restrict:"EA",templateUrl:"/views/player.html",link:function(e,n,t){e.colors=["#7CE4E8","#FFFFa5","#FC575E","#F2ADFF","#398EC4","#8CFF95"]}}}).directive("answers",function(){return{restrict:"EA",templateUrl:"/views/answers.html",link:function(e,n,t){e.$watch("game.state",function(){if("winner has been chosen"===e.game.state){var n=e.game.curQuestion,t=n.text.split("_"),i="<span style='color: "+e.colors[e.game.players[e.game.winningCardPlayer].color]+"'>",r=!1,a=function(t){var i=e.game.table[e.game.winningCard].card[t].text;return i.indexOf(".",i.length-2)===i.length-1?i=i.slice(0,i.length-1):i.indexOf("!",i.length-2)!==i.length-1&&i.indexOf("?",i.length-2)!==i.length-1||t!==n.numAnswers-1||(r=!0),i};if(t.length>1){var o=a(0);t.splice(1,0,i+o+"</span>"),2===n.numAnswers&&(o=a(1),t.splice(3,0,i+o+"</span>")),n.text=t.join(""),r&&n.text.indexOf(".",n.text.length-2)===n.text.length-1&&(n.text=n.text.slice(0,n.text.length-2))}else n.text+=" "+i+e.game.table[e.game.winningCard].card[0].text+"</span>"}})}}}).directive("question",function(){return{restrict:"EA",templateUrl:"/views/question.html",link:function(e,n,t){}}}).directive("timer",function(){return{restrict:"EA",templateUrl:"/views/timer.html",link:function(e,n,t){}}}).directive("landing",function(){return{restrict:"EA",link:function(e,n,t){e.showOptions=!0,!0===e.$$childHead.global.authenticated&&(e.showOptions=!1)}}}),angular.module("mean.system").filter("upperFirstLetter",function(){return function(e){return(e=e||"").charAt(0).toUpperCase()+e.slice(1)}}),"#_=_"==window.location.hash&&(window.location.hash="#!"),angular.module("mean.system").controller("GameController",["$scope","game","$timeout","$location","MakeAWishFactsService","$dialog",function(e,n,t,i,r,a){e.hasPickedCards=!1,e.winningCardPicked=!1,e.showTable=!1,e.modalShown=!1,e.game=n,e.pickedCards=[];var o=r.getMakeAWishFacts();e.makeAWishFact=o.pop(),e.pickCard=function(i){e.hasPickedCards||(e.pickedCards.indexOf(i.id)<0?(e.pickedCards.push(i.id),1===n.curQuestion.numAnswers?(e.sendPickedCards(),e.hasPickedCards=!0):2===n.curQuestion.numAnswers&&2===e.pickedCards.length&&(e.hasPickedCards=!0,t(e.sendPickedCards,300))):e.pickedCards.pop())},e.pointerCursorStyle=function(){return e.isCzar()&&"waiting for czar to decide"===e.game.state?{cursor:"pointer"}:{}},e.sendPickedCards=function(){n.pickCards(e.pickedCards),e.showTable=!0},e.cardIsFirstSelected=function(t){return n.curQuestion.numAnswers>1&&t===e.pickedCards[0]},e.cardIsSecondSelected=function(t){return n.curQuestion.numAnswers>1&&t===e.pickedCards[1]},e.firstAnswer=function(e){return e%2==0&&n.curQuestion.numAnswers>1},e.secondAnswer=function(e){return e%2==1&&n.curQuestion.numAnswers>1},e.showFirst=function(t){return n.curQuestion.numAnswers>1&&e.pickedCards[0]===t.id},e.showSecond=function(t){return n.curQuestion.numAnswers>1&&e.pickedCards[1]===t.id},e.isCzar=function(){return n.czar===n.playerIndex},e.isPlayer=function(e){return e===n.playerIndex},e.isCustomGame=function(){return!/^\d+$/.test(n.gameID)&&"awaiting players"===n.state},e.isPremium=function(e){return n.players[e].premium},e.currentCzar=function(e){return e===n.czar},e.winningColor=function(t){return-1!==n.winningCardPlayer&&t===n.winningCard?e.colors[n.players[n.winningCardPlayer].color]:"#f9f9f9"},e.pickWinning=function(t){e.isCzar()&&(n.pickWinning(t.card[0]),e.winningCardPicked=!0)},e.winnerPicked=function(){return-1!==n.winningCard},e.startGame=function(){n.startGame()},e.abandonGame=function(){n.leaveGame(),i.path("/")},e.$watch("game.round",function(){e.hasPickedCards=!1,e.showTable=!1,e.winningCardPicked=!1,e.makeAWishFact=o.pop(),o.length||(o=r.getMakeAWishFacts()),e.pickedCards=[]}),e.$watch("game.state",function(){"waiting for czar to decide"===n.state&&!1===e.showTable&&(e.showTable=!0)}),e.$watch("game.gameID",function(){n.gameID&&"awaiting players"===n.state&&(!e.isCustomGame()&&i.search().game?i.search({}):e.isCustomGame()&&!i.search().game&&(i.search({game:n.gameID}),e.modalShown||(setTimeout(function(){var e=document.URL;$("#lobby-how-to-play").text("Give the following link to your friends so they can join your game: "),$("#oh-el").css({"text-align":"center","font-size":"22px",background:"white",color:"black"}).text(e)},200),e.modalShown=!0)))}),i.search().game&&!/^\d+$/.test(i.search().game)?(console.log("joining custom game"),n.joinGame("joinGame",i.search().game)):i.search().custom?n.joinGame("joinGame",null,!0):n.joinGame()}]),angular.module("mean.system").controller("HeaderController",["$scope","Global",function(e,n){e.global=n,e.menu=[{title:"Articles",link:"articles"},{title:"Create New Article",link:"articles/create"}]}]),angular.module("mean.system").controller("IndexController",["$scope","Global","$location","socket","game","AvatarService",function(e,n,t,i,r,a){e.global=n,e.playAsGuest=function(){r.joinGame(),t.path("/app")},e.showError=function(){return!!t.search().error&&t.search().error},e.avatars=[],a.getAvatars().then(function(n){e.avatars=n})}]),angular.module("mean.system").factory("game",["socket","$timeout",function(e,n){var t={id:null,gameID:null,players:[],playerIndex:0,winningCard:-1,winningCardPlayer:-1,gameWinner:-1,table:[],czar:null,playerMinLimit:3,playerMaxLimit:6,pointLimit:null,state:null,round:0,time:0,curQuestion:null,notification:null,timeLimits:{},joinOverride:!1},i=[],r=!1,a=0,o=function(e){i.push(e),r||s()},s=function(){0===i.length?(clearInterval(r),r=!1,t.notification=""):(t.notification=i.shift(),r=n(s,1300))},c=!1,l=function(){t.time>0&&!c?t.time--:c=!1,n(l,950)};return e.on("id",function(e){t.id=e.id}),e.on("prepareGame",function(e){t.playerMinLimit=e.playerMinLimit,t.playerMaxLimit=e.playerMaxLimit,t.pointLimit=e.pointLimit,t.timeLimits=e.timeLimits}),e.on("gameUpdate",function(e){t.gameID!==e.gameID&&(t.gameID=e.gameID),t.joinOverride=!1,clearTimeout(t.joinOverrideTimeout);var i;for(i=0;i<e.players.length;i++)t.id===e.players[i].socketID&&(t.playerIndex=i);var r=e.state!==t.state;if(e.round!==t.round&&"awaiting players"!==e.state&&"game ended"!==e.state&&"game dissolved"!==e.state?(t.time=t.timeLimits.stateChoosing-1,c=!0):r&&"waiting for czar to decide"===e.state?(t.time=t.timeLimits.stateJudging-1,c=!0):r&&"winner has been chosen"===e.state&&(t.time=t.timeLimits.stateResults-1,c=!0),t.round=e.round,t.winningCard=e.winningCard,t.winningCardPlayer=e.winningCardPlayer,t.winnerAutopicked=e.winnerAutopicked,t.gameWinner=e.gameWinner,t.pointLimit=e.pointLimit,0===e.table.length)t.table=[];else{var s=_.difference(_.pluck(e.table,"player"),_.pluck(t.table,"player")),l=_.difference(_.pluck(t.table,"player"),_.pluck(e.table,"player"));for(i=0;i<s.length;i++)for(var u=0;u<e.table.length;u++)s[i]===e.table[u].player&&t.table.push(e.table[u],1);for(i=0;i<l.length;i++)for(var d=0;d<t.table.length;d++)l[i]===t.table[d].player&&t.table.splice(d,1)}"waiting for players to pick"===t.state&&t.players.length===e.players.length||(t.players=e.players),(r||t.curQuestion!==e.curQuestion)&&(t.state=e.state),"waiting for players to pick"===e.state?(t.czar=e.czar,t.curQuestion=e.curQuestion,t.curQuestion.text=e.curQuestion.text.replace(/_/g,"<u></u>"),r&&o(t.czar===t.playerIndex?"You're the Card Czar! Please wait!":1===t.curQuestion.numAnswers?"Select an answer!":"Select TWO answers!")):"waiting for czar to decide"===e.state?o(t.czar===t.playerIndex?"Everyone's done. Choose the winner!":"The czar is contemplating..."):"winner has been chosen"===e.state&&t.curQuestion.text.indexOf("<u></u>")>-1?t.curQuestion=e.curQuestion:"awaiting players"===e.state?a=n(function(){t.joinOverride=!0},15e3):"game dissolved"!==e.state&&"game ended"!==e.state||(t.players[t.playerIndex].hand=[],t.time=0)}),e.on("notification",function(e){o(e.notification)}),t.joinGame=function(n,t,i){n=n||"joinGame",t=t||"",i=i||!1;var r=window.user?user._id:"unauthenticated";e.emit(n,{userID:r,room:t,createPrivate:i})},t.startGame=function(){e.emit("startGame")},t.leaveGame=function(){t.players=[],t.time=0,e.emit("leaveGame")},t.pickCards=function(n){e.emit("pickCards",{cards:n})},t.pickWinning=function(n){e.emit("pickWinning",{card:n.id})},l(),t}]),angular.module("mean.system").factory("Global",[function(){var e=this;return e._data={user:window.user,authenticated:!!window.user},e._data}]).factory("AvatarService",["$http","$q",function(e,n){return{getAvatars:function(){return n.all([e.get("/avatars")]).then(function(e){return e[0].data})}}}]).factory("DonationService",["$http","$q",function(e,n){return{userDonated:function(t){return n.all([e.post("/donations",t)]).then(function(e){console.log("userDonated success",e)})}}}]).factory("MakeAWishFactsService",[function(){return{getMakeAWishFacts:function(){for(var e,n,t=["Health professionals who treat wish kids, including nurses and doctors, overwhelmingly believe that the wish experience can improve a wish kids’ physical health.","Most health professionals say a wish come true has the potential to be a positive turning point in the child’s battle for health.","Parents and volunteers observe that a wish come true makes kids feel stronger and more energetic.","Wish kids are more willing to comply with difficult, but vital, treatment regimens.","Parents and medical professionals alike describe the wish experience as a frequent turning point in wish kids’ battles for health.","A combined 89 percent of doctors, nurses and health professionals surveyed say they believe a wish experience can influence wish kids’ physical health.","Children and their parents alike experience more happiness and less fear in their lives.","Children are less isolated from friends, and feel a return of self-confidence that comes with feeling “normal” again.","Children are empowered to take back control of their lives, and to keep up the fight against their life-threatening medical conditions.","Parents say their family units – often strained to the limit by stresses of the illnesses – are repaired and strengthened through the shared experience of the wish process.","Ninety-nine percent of parents reported that the wish experience gave their children increased feelings of happiness and 96 percent said that the wish experience strengthened their families.","A wish is much more than just a nice thing. And its reach extends far beyond a single event, or moment in time. Wish kids, parents, medical professionals, volunteers, and others say that wish experiences can change the lives of everyone involved, forever.","Make-A-Wish® grants a wish, on average, every 38 minutes and, on average, a child is referred for a wish every 28 minutes.","Every wish experience is driven by the wish kid’s interests, creativity and personality.","Make-A-Wish granted nearly 14,000 wishes in 2012 alone.","To qualify for a wish, a child with a life-threatening medical condition must be older than 2½ years and younger than 18 (at the time of referral) and must not have received a wish from another wish-granting organization.","A child can be referred by a parent or guardian, a medical professional, or by the child.","Following referral, a certified medical professional must verify that the child has a life-threatening medical condition. There are no other qualifications based on sex, race, religion, socioeconomic status or any other demographic category.","Make-A-Wish chapters serve every community in the United States and its territories.","Make-A-Wish has approximately 25,000 active volunteers in the United States.","Make-A-Wish needs 2.5 billion frequent flier miles to meet all the travel needs for wish kids and their families.","Nearly 75 percent of wish experiences involve travel.","The Walt Disney Company is involved in 40 percent of the wishes Make-A-Wish grants.","As of August 2012, the average cost of a wish was $8,141."],i=t.length;i;)e=t[n=Math.floor(Math.random()*i--)],t[n]=t[i],t[i]=e;return t}}}]),angular.module("mean.system").factory("socket",["$rootScope",function(e){var n=io.connect();return{on:function(t,i){n.on(t,function(){var t=arguments;e.safeApply(function(){i.apply(n,t)})})},emit:function(t,i,r){n.emit(t,i,function(){}),e.safeApply(function(){r&&r.apply(n,args)})},removeAllListeners:function(t,i){n.removeAllListeners(t,function(){var t=arguments;e.safeApply(function(){i&&i.apply(n,t)})})}}}]);var mongoose=require("mongoose"),config=require("../../config/config"),AnswerSchema=new(Schema=mongoose.Schema)({id:{type:Number},text:{type:String,default:"",trim:!0},official:{type:Boolean},expansion:{type:String,default:"",trim:!0}});AnswerSchema.statics={load:function(e,n){this.findOne({id:e}).select("-_id").exec(n)}},mongoose.model("Answer",AnswerSchema);var mongoose=require("mongoose"),config=require("../../config/config"),QuestionSchema=new(Schema=mongoose.Schema)({id:{type:Number},text:{type:String,default:"",trim:!0},numAnswers:{type:Number},official:{type:Boolean},expansion:{type:String,default:"",trim:!0}});QuestionSchema.statics={load:function(e,n){this.findOne({id:e}).select("-_id").exec(n)}},mongoose.model("Question",QuestionSchema);var Schema=(mongoose=require("mongoose")).Schema,bcrypt=require("bcryptjs"),_=require("underscore"),authTypes=["github","twitter","facebook","google"],UserSchema=new Schema({name:String,email:String,username:String,provider:String,avatar:String,premium:Number,donations:[],hashed_password:String,facebook:{},twitter:{},github:{},google:{}});UserSchema.virtual("password").set(function(e){this._password=e,this.hashed_password=this.encryptPassword(e)}).get(function(){return this._password});var validatePresenceOf=function(e){return e&&e.length};UserSchema.path("name").validate(function(e){return-1!==authTypes.indexOf(this.provider)||e.length},"Name cannot be blank"),UserSchema.path("email").validate(function(e){return-1!==authTypes.indexOf(this.provider)||e.length},"Email cannot be blank"),UserSchema.path("username").validate(function(e){return-1!==authTypes.indexOf(this.provider)||e.length},"Username cannot be blank"),UserSchema.path("hashed_password").validate(function(e){return-1!==authTypes.indexOf(this.provider)||e.length},"Password cannot be blank"),UserSchema.pre("save",function(e){if(!this.isNew)return e();validatePresenceOf(this.password)||-1!==authTypes.indexOf(this.provider)?e():e(new Error("Invalid password"))}),UserSchema.methods={authenticate:function(e){return!(!e||!this.hashed_password)&&bcrypt.compareSync(e,this.hashed_password)},encryptPassword:function(e){return e?bcrypt.hashSync(e,bcrypt.genSaltSync(10)):""}},mongoose.model("User",UserSchema);var mongoose=require("mongoose"),async=require("async"),Answer=mongoose.model("Answer"),_=require("underscore");exports.answer=function(e,n,t,i){Answer.load(i,function(n,r){return n?t(n):r?(e.answer=r,void t()):t(new Error("Failed to load answer "+i))})},exports.show=function(e,n){n.jsonp(e.answer)},exports.all=function(e,n){Answer.find({official:!0}).select("-_id").exec(function(e,t){e?n.render("error",{status:500}):n.jsonp(t)})},exports.allAnswersForGame=function(e){Answer.find({official:!0}).select("-_id").exec(function(n,t){n?console.log(n):e(t)})},avatars=["/img/chosen/E01.png","/img/chosen/F01.png","/img/chosen/FA04.png","/img/chosen/FB03.png","/img/chosen/FC01.png","/img/chosen/FD01.png","/img/chosen/FE01.png","/img/chosen/FH03.png","/img/chosen/FI02.png","/img/chosen/H01.png","/img/chosen/J01.png","/img/chosen/M05.png","/img/chosen/N02.png","/img/chosen/N03.png","/img/chosen/N04.png","/img/chosen/N05.png"],exports.allJSON=function(e,n){n.jsonp(avatars.slice(0,12))},exports.all=function(){return avatars};var mongoose=require("mongoose"),async=require("async"),_=require("underscore");exports.play=function(e,n){"custom"===Object.keys(e.query)[0]?n.redirect("/#!/app?custom"):n.redirect("/#!/app")},exports.render=function(e,n){n.render("index",{user:e.user?JSON.stringify(e.user):"null"})};var mongoose=require("mongoose"),async=require("async"),Question=mongoose.model("Question"),_=require("underscore");exports.question=function(e,n,t,i){Question.load(i,function(n,r){return n?t(n):r?(e.question=r,void t()):t(new Error("Failed to load question "+i))})},exports.show=function(e,n){n.jsonp(e.question)},exports.all=function(e,n){Question.find({official:!0,numAnswers:{$lt:3}}).select("-_id").exec(function(e,t){e?n.render("error",{status:500}):n.jsonp(t)})},exports.allQuestionsForGame=function(e){Question.find({official:!0,numAnswers:{$lt:3}}).select("-_id").exec(function(n,t){n?console.log(n):e(t)})};var User=(mongoose=require("mongoose")).model("User"),avatars=require("./avatars").all();exports.authCallback=function(e,n,t){n.redirect("/chooseavatars")},exports.signin=function(e,n){e.user?n.redirect("/#!/app"):n.redirect("/#!/signin?error=invalid")},exports.signup=function(e,n){e.user?n.redirect("/#!/app"):n.redirect("/#!/signup")},exports.signout=function(e,n){e.logout(),n.redirect("/")},exports.session=function(e,n){n.redirect("/")},exports.checkAvatar=function(e,n){e.user&&e.user._id?User.findOne({_id:e.user._id}).exec(function(e,t){void 0!==t.avatar?n.redirect("/#!/"):n.redirect("/#!/choose-avatar")}):n.redirect("/")},exports.create=function(e,n){if(!(e.body.name&&e.body.password&&e.body.email))return n.redirect("/#!/signup?error=incomplete");User.findOne({email:e.body.email}).exec(function(t,i){if(i)return n.redirect("/#!/signup?error=existinguser");var r=new User(e.body);r.avatar=avatars[r.avatar],r.provider="local",r.save(function(t){if(t)return n.render("/#!/signup?error=unknown",{errors:t.errors,user:r});e.logIn(r,function(e){return e?next(e):n.redirect("/#!/")})})})},exports.avatars=function(e,n){return e.user&&e.user._id&&void 0!==e.body.avatar&&/\d/.test(e.body.avatar)&&avatars[e.body.avatar]&&User.findOne({_id:e.user._id}).exec(function(n,t){t.avatar=avatars[e.body.avatar],t.save()}),n.redirect("/#!/app")},exports.addDonation=function(e,n){e.body&&e.user&&e.user._id&&e.body.amount&&e.body.crowdrise_donation_id&&e.body.donor_name&&User.findOne({_id:e.user._id}).exec(function(n,t){for(var i=!1,r=0;r<t.donations.length;r++)t.donations[r].crowdrise_donation_id===e.body.crowdrise_donation_id&&(i=!0);i||(console.log("Validated donation"),t.donations.push(e.body),t.premium=1,t.save())}),n.send()},exports.show=function(e,n){var t=e.profile;n.render("users/show",{title:t.name,user:t})},exports.me=function(e,n){n.jsonp(e.user||null)},exports.user=function(e,n,t,i){User.findOne({_id:i}).exec(function(n,r){return n?t(n):r?(e.profile=r,void t()):t(new Error("Failed to load User "+i))})};